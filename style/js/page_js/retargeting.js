(function(){!function(){var e=window.Cookies,n=window.Cookies=function(){function u(){var e=0;var n={};for(;e<arguments.length;e++){var t=arguments[e];for(var r in t){n[r]=t[r]}}return n}function a(e){return e.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}function e(f){function c(){}function t(e,n,t){if(typeof document==="undefined"){return}t=u({path:"/"},c.defaults,t);if(typeof t.expires==="number"){t.expires=new Date(new Date*1+t.expires*86400000)}t.expires=t.expires?t.expires.toUTCString():"";try{var r=JSON.stringify(n);if(/^[\{\[]/.test(r)){n=r}}catch(e){}n=f.write?f.write(n,e):encodeURIComponent(String(n)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent);e=encodeURIComponent(String(e)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var o="";for(var i in t){if(!t[i]){continue}o+="; "+i;if(t[i]===true){continue}o+="="+t[i].split(";")[0]}return document.cookie=e+"="+n+o}function n(e,n){if(typeof document==="undefined"){return}var t={};var r=document.cookie?document.cookie.split("; "):[];var o=0;for(;o<r.length;o++){var i=r[o].split("=");var c=i.slice(1).join("=");if(!n&&c.charAt(0)==='"'){c=c.slice(1,-1)}try{var u=a(i[0]);c=(f.read||f)(c,u)||a(c);if(n){try{c=JSON.parse(c)}catch(e){}}t[u]=c;if(e===u){break}}catch(e){}}return e?t[e]:t}c.set=t;c.get=function(e){return n(e,false)};c.getJSON=function(e){return n(e,true)};c.remove=function(e,n){t(e,"",u(n,{expires:-1}))};c.defaults={};c.withConverter=e;return c}return e(function(){})}();n.noConflict=function(){return window.Cookies=e,n}}();function checkSupportLocalstorage(){try{localStorage.setItem("test","test");localStorage.removeItem("test");return !0}catch(e){return !1}}function getFromLocalStorage(key){return localStorage.getItem(key)}function setToLocalStorage(key,value){localStorage.setItem(key,value)}var eventMethod=window.addEventListener?"addEventListener":"attachEvent";var eventer=window[eventMethod];var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";var localStorageFingerPrintKey="MEDIAAD_USER_ID";var fidHolder={val:null,listeners:[],set value(val){this.val=val;while(this.listeners.length>0){this.listeners.pop()(val)}},get value(){return this.val},listen:function(listener){this.listeners.push(listener)}};if(checkSupportLocalstorage()){fidHolder.value=getFromLocalStorage(localStorageFingerPrintKey)}else{if(Cookies.get(localStorageFingerPrintKey)){fidHolder.value=Cookies.get(localStorageFingerPrintKey)}}eventer(messageEvent,function(e){try{var message=e.data||e.message;if(message===null||message===undefined||typeof message.indexOf==="undefined"){return}if(message.indexOf("mediaad-fid:")===0){var fingerprint=message.split(":")[1];fidHolder.value=fingerprint;Cookies.set(localStorageFingerPrintKey,fingerprint,{expires:36500000});setToLocalStorage(localStorageFingerPrintKey,fingerprint)}}catch(e){console.log(e)}});function withFid(callback){var val=fidHolder.value;if(val){try{callback(val)}catch(e){}}else{fidHolder.listen(function(val){if(val){try{callback(val)}catch(e){}}})}}function appendIframe(src){if(src===null||src===undefined){return}var iFrame=document.createElement("iframe");iFrame.style.display="none";iFrame.src=src;try{document.body.appendChild(iFrame)}catch(e){console.log(e.message)}}var allTags=[{id:68,title:"پروداکت ",pattern_type:"contains",query:"/c",trigger_type:"timeToStay",custom_script:null,css_selector:"",time_to_remain:20,element_id:"MED-lkGkq"},{id:69,title:"لندینگ3",pattern_type:"contains",query:"/landing/3",trigger_type:"timeToStay",custom_script:null,css_selector:"",time_to_remain:15,element_id:"MED-A17Cs"},{id:72,title:"سبد1",pattern_type:"contains",query:"/checkout/auth",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-BOscC"},{id:89,title:"سبد2",pattern_type:"contains",query:"/checkout/review",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-vQHhK"},{id:90,title:"سبد3",pattern_type:"contains",query:"/checkout/payment",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-ASiGH"},{id:114,title:"لندینگ5",pattern_type:"contains",query:"/landing/5",trigger_type:"timeToStay",custom_script:null,css_selector:"",time_to_remain:12,element_id:"MED-6ojpW"},{id:136,title:" همایشها ",pattern_type:"contains",query:"/product/search",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-UKHrP"},{id:137,title:"محصول ۲۳۲",pattern_type:"contains",query:"product/۲۳۲",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-84zed"},{id:138,title:"نظام قدیم",pattern_type:"contains",query:"landing/5",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-RZOLl"},{id:139,title:"نظام جدید",pattern_type:"contains",query:"landing/6",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-SG0RM"},{id:144,title:"زیست دهم",pattern_type:"contains",query:"/c?tags[0]=دهم",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-W35Rk"},{id:145,title:"شیمی267",pattern_type:"contains",query:"product/267",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-4gyxg"},{id:146,title:"فیزیک266",pattern_type:"contains",query:"product/266",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-NMkgc"},{id:147,title:"زیست234",pattern_type:"contains",query:"product/234",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-YBdyD"},{id:148,title:"شیمی230",pattern_type:"contains",query:"product/230",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-M3Dd0"},{id:149,title:"دهم",pattern_type:"contains",query:"product/181",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-zTlPz"},{id:150,title:"ریاضی242",pattern_type:"contains",query:"product/242",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-Qm1zi"},{id:155,title:"همه",pattern_type:"contains",query:"/",trigger_type:"timeToStay",custom_script:null,css_selector:"",time_to_remain:8,element_id:"MED-hZLOI"},{id:167,title:"زیست265",pattern_type:"contains",query:"product/265",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-VHsCv"},{id:176,title:"فیزیک232",pattern_type:"contains",query:"product/232",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-Zv5gc"},{id:177,title:"عربی236",pattern_type:"contains",query:"product/236",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-14ufq"},{id:178,title:"دوره275",pattern_type:"contains",query:"product/275",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-jbKXB"},{id:197,title:"تفتان",pattern_type:"contains",query:"product/276",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-Nulho"},{id:1106,title:"نمایش آلا",pattern_type:"contains",query:"/",trigger_type:"showPage",custom_script:null,css_selector:"",time_to_remain:0,element_id:"MED-BZgSt"}];var pageTags=[];var htmlElementTagToCounter={};var tagToTimeoutCounter={};var currentPath=getCurrentPath();var timeouts=[];var API_URL="https://api.mediaad.org";var SERVE_URL="https://api.mediaad.org/v1/events";var MAX_INTERVAL_RESET=60;setInterval(function(){checkUrlChange()},1000);updatePageTags();var urlParams=new URLSearchParams(window.location.search);if(urlParams.has("utm_ma")){Cookies.set("clickId",urlParams.get("utm_ma"),{expires:20})}window.addEventListener("load",function(){appendIframe("https://mediacdn.mediaad.org/static/fingerprint.html");withFid(function(fid){sendGetRequest(SERVE_URL+"/page/loaded?fid="+fid)});setTimeout(function(){sendGetRequest(SERVE_URL+"/session/10")},10000)});function getCurrentPath(){return decodeURIComponent(location.href.substr(location.origin.length))}function getCookie(name){var cookie=Cookies.get(name);if(cookie===undefined||cookie===null){return null}else{return cookie}}function refresh(){tagToTimeoutCounter={};htmlElementTagToCounter={};pageTags=[];var tempTimeouts=timeouts.slice();timeouts=[];var counter=0;if(tempTimeouts.length==0){updatePageTags()}tempTimeouts.forEach(function(timeout){clearTimeout(timeout);if(++counter==tempTimeouts.length){updatePageTags()}})}function updatePageTags(){pageTags=[];var counter=0;allTags.forEach(function(tag){if(isSuitable(tag)){pageTags.push(tag)}if(++counter==allTags.length){checkTagsTrigger()}})}function checkUrlChange(){var newPath=getCurrentPath();if(newPath!==currentPath){currentPath=newPath;refresh()}}function applyTriggerEvent(tag){if(tag.trigger_type==="showPage"){assignTagToUser(tag)}else{if(tag.trigger_type==="clickOnElement"){if(!(tag.css_selector in tagToTimeoutCounter)){tagToTimeoutCounter[tag.css_selector]=0}var checkExist=setInterval(function(){tagToTimeoutCounter[tag.css_selector]=tagToTimeoutCounter[tag.css_selector]+1;var elements=document.querySelectorAll(tag.css_selector);if(tagToTimeoutCounter[tag.css_selector]>=MAX_INTERVAL_RESET||elements.length>0){clearInterval(checkExist)}elements.forEach(function(element){element.addEventListener("click",function(){assignTagToUser(tag)})})},1000);timeouts.push(checkExist)}else{if(tag.trigger_type==="submitForm"){if(!(tag.css_selector in tagToTimeoutCounter)){tagToTimeoutCounter[tag.css_selector]=0}var checkExist=setInterval(function(){tagToTimeoutCounter[tag.css_selector]=tagToTimeoutCounter[tag.css_selector]+1;var elements=document.querySelectorAll(tag.css_selector);if(tagToTimeoutCounter[tag.css_selector]>=MAX_INTERVAL_RESET||elements.length>0){clearInterval(checkExist)}elements.forEach(function(element){element.addEventListener("submit",function(){console.log("onSubmitListener added");assignTagToUser(tag)})})},1000);timeouts.push(checkExist)}else{if(tag.trigger_type==="timeToStay"){var timeout=setTimeout(function(){assignTagToUser(tag)},tag.time_to_remain*1000);timeouts.push(timeout)}else{if(tag.trigger_type==="customScript"){try{var result=eval(tag.custom_script);if(result===true){assignTagToUser(tag)}}catch(e){console.log(e)}}}}}}}function checkTagsTrigger(){pageTags.forEach(function(tag){applyTriggerEvent(tag)})}function assignTagToUser(tag){var tagName="MED-tag-"+tag.id;if(sessionStorage.getItem(tagName)){return}try{withFid(function(fid){sendPostRequest(SERVE_URL+"/add-tag-to-visitor?fid="+fid,{tagId:tag.id,date:Date.now()})});var clickId=getCookie("clickId");if(clickId!==null){sendGetRequest(SERVE_URL+"/post-back?actionName="+tag.title+"&clickId="+clickId)}}finally{sessionStorage.setItem(tagName,"1")}}function isPrefix(mainString,prefix){return(mainString.substring(0,prefix.length)===prefix)}function isPostfix(mainString,postfix){return(mainString.substring(mainString.length-postfix.length,mainString.length)===postfix)}function isSuitable(tag){currentPath=getCurrentPath();if(tag.pattern_type==="startsWith"){return isPrefix(currentPath,tag.query)}else{if(tag.pattern_type==="htmlElement"){htmlElementTagToCounter[tag.id]=0;var checkExist=setInterval(function(){htmlElementTagToCounter[tag.id]=htmlElementTagToCounter[tag.id]+1;var element=document.getElementById(tag.element_id);if(element!=null){htmlElementTagToCounter[tag.id]=MAX_INTERVAL_RESET;clearInterval(checkExist);applyTriggerEvent(tag)}if(htmlElementTagToCounter[tag.id]>=MAX_INTERVAL_RESET){clearInterval(checkExist)}},1000);timeouts.push(checkExist);return false}else{if(tag.pattern_type==="endsWith"){return isPostfix(currentPath,tag.query)}else{if(tag.pattern_type==="equalsTo"){return currentPath===tag.query}else{if(tag.pattern_type==="contains"){return currentPath.includes(tag.query)}else{if(tag.pattern_type==="regex"){var pattern=new RegExp(tag.query);return pattern.test(currentPath)}}}}}}}function sendPostRequest(link,obj){var xhr=new XMLHttpRequest();xhr.open("POST",link);xhr.withCredentials=!0;xhr.setRequestHeader("Content-Type","application/json; charset=utf-8");if(obj){xhr.send(JSON.stringify(obj))}else{xhr.send()}}function sendGetRequest(link){var xhr=new XMLHttpRequest();xhr.open("GET",link);xhr.send(null)}})();(function(){!function(){var e=window.Cookies,n=window.Cookies=function(){function u(){var e=0;var n={};for(;e<arguments.length;e++){var t=arguments[e];for(var r in t){n[r]=t[r]}}return n}function a(e){return e.replace(/(%[0-9A-Z]{2})+/g,decodeURIComponent)}function e(f){function c(){}function t(e,n,t){if(typeof document==="undefined"){return}t=u({path:"/"},c.defaults,t);if(typeof t.expires==="number"){t.expires=new Date(new Date*1+t.expires*86400000)}t.expires=t.expires?t.expires.toUTCString():"";try{var r=JSON.stringify(n);if(/^[\{\[]/.test(r)){n=r}}catch(e){}n=f.write?f.write(n,e):encodeURIComponent(String(n)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent);e=encodeURIComponent(String(e)).replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent).replace(/[\(\)]/g,escape);var o="";for(var i in t){if(!t[i]){continue}o+="; "+i;if(t[i]===true){continue}o+="="+t[i].split(";")[0]}return document.cookie=e+"="+n+o}function n(e,n){if(typeof document==="undefined"){return}var t={};var r=document.cookie?document.cookie.split("; "):[];var o=0;for(;o<r.length;o++){var i=r[o].split("=");var c=i.slice(1).join("=");if(!n&&c.charAt(0)==='"'){c=c.slice(1,-1)}try{var u=a(i[0]);c=(f.read||f)(c,u)||a(c);if(n){try{c=JSON.parse(c)}catch(e){}}t[u]=c;if(e===u){break}}catch(e){}}return e?t[e]:t}c.set=t;c.get=function(e){return n(e,false)};c.getJSON=function(e){return n(e,true)};c.remove=function(e,n){t(e,"",u(n,{expires:-1}))};c.defaults={};c.withConverter=e;return c}return e(function(){})}();n.noConflict=function(){return window.Cookies=e,n}}();function checkSupportLocalStorage(){try{localStorage.setItem("test","test");localStorage.removeItem("test");return !0}catch(e){return !1}}function getFromLocalStorage(key){return localStorage.getItem(key)}function getCurrentUrl(){return decodeURIComponent(location.href)}var propertySelector={title:{selector:"meta[property='og:title']",field:"content",required:true,value:null,code:null},link:{selector:"link[rel='canonical']",field:"href",required:true,value:null,code:null},image:{selector:"meta[property='og:image']",field:"content",required:true,value:null,code:null},available:{selector:"",field:"",required:false,value:null,code:"document.querySelector('button.btn-success.btnAddToCart') !== null"}};var campaignId=2446;var API_URL="https://api.mediaad.org";var localStorageFingerPrintKey="MEDIAAD_USER_ID";var eventMethod=window.addEventListener?"addEventListener":"attachEvent";var eventer=window[eventMethod];var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";var loadEvent=eventMethod==="attachEvent"?"onload":"load";var fidHolder={val:null,listeners:[],set value(val){this.val=val;while(this.listeners.length>0){this.listeners.pop()(val)}},get value(){return this.val},listen:function(listener){this.listeners.push(listener)}};if(checkSupportLocalStorage()){fidHolder.value=getFromLocalStorage(localStorageFingerPrintKey)}else{if(Cookies.get(localStorageFingerPrintKey)){fidHolder.value=Cookies.get(localStorageFingerPrintKey)}}eventer(messageEvent,function(e){try{var message=e.data||e.message;if(message===null||message===undefined||typeof message.indexOf==="undefined"){return}if(message.indexOf("mediaad-fid:")===0){fidHolder.value=message.split(":")[1]}}catch(e){console.log(e)}});function withFid(callback){var val=fidHolder.value;if(val){try{callback(val)}catch(e){}}else{fidHolder.listen(function(val){if(val){try{callback(val)}catch(e){}}})}}var hasRequiredElements=true;var currentPath=getCurrentUrl();var persianNumbers=[/۰/g,/۱/g,/۲/g,/۳/g,/۴/g,/۵/g,/۶/g,/۷/g,/۸/g,/۹/g];var arabicNumbers=[/٠/g,/١/g,/٢/g,/٣/g,/٤/g,/٥/g,/٦/g,/٧/g,/٨/g,/٩/g];var fixNumbers=function(str){if(typeof str==="string"){for(var i=0;i<10;i++){str=str.replace(persianNumbers[i],i).replace(arabicNumbers[i],i)}}return str};eventer(loadEvent,run);setInterval(function(){if(currentPath!==getCurrentUrl()){currentPath=getCurrentUrl();run()}},1500);function findElementAndValue(name){var property=propertySelector[name];if(!property){return null}var selector=property.selector;if(!selector){return null}var element=document.querySelector(selector);if(!element){if(property.required){hasRequiredElements=false}return null}if(propertySelector[name].value!==null){return element[property.field]===propertySelector[name].value}else{if(property.field==="style.backgroundImage"){return getBackgroundStyleUrl(element)}return element[property.field]}}function getBackgroundStyleUrl(element){return extractUrlValue(element.style.backgroundImage)}function extractUrlValue(str){return str.match(/url\(["']?([^"']*)["']?\)/)[1]}function getFieldValue(name){var result;if(propertySelector[name]&&propertySelector[name].code){try{result=eval(propertySelector[name].code)}catch(err){result=null}}else{result=findElementAndValue(name)}checkRequired(name,result);return result}function checkRequired(name,v){if((v===null||v===undefined)&&propertySelector[name]&&propertySelector[name].required){hasRequiredElements=false}}function getLink(){var link=getFieldValue("link");if(link){return link}return window.location.href.split("?")[0]}function run(){setTimeout(send,3000)}function send(){var link=getLink();var sessionKey="MED-prod-"+link;if(sessionStorage.getItem(sessionKey)){return}sendWith(link,sessionKey);if(sessionStorage.getItem(sessionKey)){return}if(currentPath.indexOf("&utm_ma=")!==-1){sendPostRequest(API_URL+"/v1/events/deleted-product",{campaignId:campaignId,link:link})}}function sendWith(link,sessionKey){hasRequiredElements=true;var title=getFieldValue("title");var category=getFieldValue("category");var available=getFieldValue("available");var price=getFieldValue("price");var oldPrice=getFieldValue("oldPrice");var image=getFieldValue("image");var exp=getFieldValue("exp");if(!link.includes("alaatv.com/product/")&&!link.includes("alaatv.com/c/")){return}if(hasRequiredElements){if(link.includes("alaatv.com/c/")){available=true}if(!image.startsWith("http")){image="https://cdn.alaatv.com/"+escape(image)}}var body={campaignId:campaignId,link:link,title:title,category:category,available:available,price:price,oldPrice:oldPrice,image:image,exp:exp,relatives:getRelatives()};if(hasRequiredElements){withFid(function(fid){sendPostRequest(API_URL+"/v1/events/product?fid="+fid,body)})}else{if(currentPath.indexOf("&utm_ma=")!==-1){sendPostRequest(API_URL+"/v1/events/deleted-product",{campaignId:campaignId,link:link})}}sessionStorage.setItem(sessionKey,"1")}function getRelatives(){var property=propertySelector.relatives;if(!property||!property.selector){return[]}var result=[];var relativeProducts=document.querySelectorAll(property.selector);if(relativeProducts){Array.from(relativeProducts).forEach(function(item){result.push(item[property.field])})}return result}function sendPostRequest(link,obj){var xmlHttp=new XMLHttpRequest();xmlHttp.open("POST",link);xmlHttp.withCredentials=!0;xmlHttp.setRequestHeader("Content-Type","application/json; charset=utf-8");xmlHttp.send(JSON.stringify(obj))}})();